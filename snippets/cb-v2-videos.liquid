{%- comment -%}
  CB Commerce V2 - Videos Component
  Clean format-based layout: Landscape (YouTube, Vimeo) + Portrait (Shorts, TikTok)
  No platform headings, no Instagram (unreliable embeds)
{%- endcomment -%}

{%- if videos_json != blank -%}
  {%- assign videos = videos_json | parse_json -%}
{%- else -%}
  {%- assign videos = nil -%}
{%- endif -%}

{%- if videos != blank and videos.size > 0 -%}
  {%- comment -%} Separate videos by format {%- endcomment -%}
  {%- assign landscape_videos = '' -%}
  {%- assign portrait_videos = '' -%}

  {%- for video in videos -%}
    {%- case video.platform -%}
      {%- when 'youtube' or 'vimeo' -%}
        {%- if landscape_videos == '' -%}
          {%- assign landscape_videos = video.platform | append: '::' | append: video.url -%}
        {%- else -%}
          {%- assign landscape_videos = landscape_videos | append: '|||' | append: video.platform | append: '::' | append: video.url -%}
        {%- endif -%}
      {%- when 'youtube_shorts' or 'tiktok' -%}
        {%- if portrait_videos == '' -%}
          {%- assign portrait_videos = video.platform | append: '::' | append: video.url -%}
        {%- else -%}
          {%- assign portrait_videos = portrait_videos | append: '|||' | append: video.platform | append: '::' | append: video.url -%}
        {%- endif -%}
    {%- endcase -%}
  {%- endfor -%}

  <div class="cb-videos">

    {%- comment -%} ========== LANDSCAPE VIDEOS ========== {%- endcomment -%}
    {%- if landscape_videos != '' -%}
      {%- assign landscape_array = landscape_videos | split: '|||' -%}
      <div class="cb-videos__landscape">
        {%- for item in landscape_array -%}
          {%- assign parts = item | split: '::' -%}
          {%- assign platform = parts[0] -%}
          {%- assign video_url = parts[1] -%}
          {%- assign video_id = '' -%}

          {%- if platform == 'youtube' -%}
            {%- if video_url contains 'youtube.com/watch' -%}
              {%- assign video_id = video_url | split: 'v=' | last | split: '&' | first -%}
            {%- elsif video_url contains 'youtu.be/' -%}
              {%- assign video_id = video_url | split: 'youtu.be/' | last | split: '?' | first -%}
            {%- endif -%}
            {%- if video_id != blank -%}
              <div class="cb-video cb-video--landscape">
                <iframe
                  src="https://www.youtube.com/embed/{{ video_id }}"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                  allowfullscreen
                  loading="lazy"
                  title="Video"
                ></iframe>
              </div>
            {%- endif -%}
          {%- elsif platform == 'vimeo' -%}
            {%- if video_url contains 'vimeo.com/' -%}
              {%- assign video_id = video_url | split: 'vimeo.com/' | last | split: '?' | first | split: '/' | first -%}
            {%- endif -%}
            {%- if video_id != blank -%}
              <div class="cb-video cb-video--landscape">
                <iframe
                  src="https://player.vimeo.com/video/{{ video_id }}"
                  allow="autoplay; fullscreen; picture-in-picture"
                  allowfullscreen
                  loading="lazy"
                  title="Video"
                ></iframe>
              </div>
            {%- endif -%}
          {%- endif -%}
        {%- endfor -%}
      </div>
    {%- endif -%}

    {%- comment -%} ========== PORTRAIT VIDEOS ========== {%- endcomment -%}
    {%- if portrait_videos != '' -%}
      {%- assign portrait_array = portrait_videos | split: '|||' -%}

      {%- comment -%} Load TikTok embed script if needed {%- endcomment -%}
      {%- if portrait_videos contains 'tiktok' -%}
        <script async src="https://www.tiktok.com/embed.js"></script>
      {%- endif -%}

      <div class="cb-videos__portrait">
        {%- for item in portrait_array -%}
          {%- assign parts = item | split: '::' -%}
          {%- assign platform = parts[0] -%}
          {%- assign video_url = parts[1] -%}
          {%- assign video_id = '' -%}

          {%- if platform == 'youtube_shorts' -%}
            {%- if video_url contains '/shorts/' -%}
              {%- assign video_id = video_url | split: '/shorts/' | last | split: '?' | first -%}
            {%- endif -%}
            {%- if video_id != blank -%}
              <div class="cb-video cb-video--portrait">
                <iframe
                  src="https://www.youtube.com/embed/{{ video_id }}"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                  allowfullscreen
                  loading="lazy"
                  title="Video"
                ></iframe>
              </div>
            {%- endif -%}
          {%- elsif platform == 'tiktok' -%}
            {%- if video_url contains '/video/' -%}
              {%- assign video_id = video_url | split: '/video/' | last | split: '?' | first -%}
            {%- endif -%}
            {%- if video_id != blank -%}
              <div class="cb-video cb-video--portrait cb-video--tiktok" data-video-id="{{ video_id }}">
                <div class="cb-tiktok-inner">
                  <blockquote
                    class="tiktok-embed"
                    cite="{{ video_url }}"
                    data-video-id="{{ video_id }}"
                  >
                    <section style="display:none;">
                      <a target="_blank" href="{{ video_url }}" rel="noopener">View on TikTok</a>
                    </section>
                  </blockquote>
                </div>
              </div>
            {%- endif -%}
          {%- endif -%}
        {%- endfor -%}
      </div>

      {%- if portrait_videos contains 'tiktok' -%}
        <script>
          (function() {
            function styleTikTokEmbeds() {
              document.querySelectorAll('.cb-video--tiktok').forEach(function(container) {
                var inner = container.querySelector('.cb-tiktok-inner');
                if (!inner) return;

                // Style the inner wrapper
                inner.style.cssText = 'position:relative;width:75%;height:100%;margin:0 auto;';

                // Find TikTok's injected container (first div child or the embed itself)
                var tiktokContainer = inner.querySelector('div') || inner.firstElementChild;
                if (tiktokContainer && tiktokContainer.tagName !== 'BLOCKQUOTE') {
                  tiktokContainer.style.cssText = 'position:absolute;top:0;left:46px;right:-50px;bottom:0;';
                }

                // Style the iframe
                var iframe = container.querySelector('iframe');
                if (iframe) {
                  iframe.style.cssText = 'width:100%;height:100%;border:none;';
                  iframe.setAttribute('scrolling', 'no');
                }
              });
            }
            var check = setInterval(styleTikTokEmbeds, 100);
            setTimeout(function() { clearInterval(check); }, 15000);
          })();
        </script>
      {%- endif -%}
    {%- endif -%}

  </div>
{%- else -%}
  <div class="cb-empty-state cb-empty-state--small">
    <p>No videos yet.</p>
  </div>
{%- endif -%}
