{%- comment -%}
  CB Commerce V2 - Browse View Component
  Contained shop section with horizontal scroll products and view states
  States: grid → product → details → cart

  Required variables:
  - creator_name: For section header
  - username: Creator username
  - collection: Shopify collection object
  - categories_array: Array of category strings
  - links_json: JSON string of links
  - videos_json: JSON string of video embeds (YouTube, TikTok, etc.)
  - social_stats: Social stats object
  - instagram_url, tiktok_url, youtube_url, twitter_url: Social URLs
  - enable_music_player: Boolean to enable music player
  - music_player_title: Title for music section
  - music_player_theme: Spotify theme (auto/white/black)
  - music_items: Array of music items with url/title
{%- endcomment -%}

<div class="cb-view cb-view--browse" data-view-content="browse">

  {%- comment -%} ========== CONTAINED SHOP SECTION ========== {%- endcomment -%}
  <div class="cb-shop" data-shop-view="grid">
    {%- comment -%} Dynamic Header {%- endcomment -%}
    <div class="cb-shop__header">
      {%- comment -%} Left side - title or back button {%- endcomment -%}
      <div class="cb-shop__header-left">
        <h2 class="cb-shop__title" data-shop-header-grid>
          {{ creator_name | split: ' ' | first | upcase | default: 'CREATOR' }} PICKS
        </h2>
        <button class="cb-shop__back-btn" data-shop-header-product data-action="shop-back-to-grid" style="display: none;">
          ← BACK TO ALL
        </button>
        <button class="cb-shop__back-btn" data-shop-header-details data-action="shop-back-to-product" style="display: none;">
          ← BACK
        </button>
        <button class="cb-shop__back-btn" data-shop-header-cart data-action="shop-back-to-grid" style="display: none;">
          ← BACK
        </button>
      </div>

      {%- comment -%} Center - cart title {%- endcomment -%}
      <span class="cb-shop__title" data-shop-cart-title style="display: none;">CART</span>

      {%- comment -%} Right side - details link + cart button {%- endcomment -%}
      <div class="cb-shop__header-right">
        <button class="cb-shop__details-link" data-action="shop-show-details" style="display: none;">
          +details
        </button>
        <button class="cb-shop__cart-btn" data-action="shop-show-cart">
          <svg class="cb-shop__cart-icon" width="18" height="20" viewBox="0 -1 24 26" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M8 6V4a4 4 0 1 1 8 0v2"/>
            <rect x="3" y="6" width="18" height="16" rx="2"/>
          </svg>
          <span class="cb-shop__cart-count" data-shop-cart-count></span>
        </button>
      </div>
    </div>

    {%- comment -%} Category Tabs - Only in grid view {%- endcomment -%}
    <div class="cb-shop__categories" data-shop-categories>
      <button class="cb-shop__category active" data-category="all">All</button>
      {%- for category in categories_array -%}
        {%- if category != blank -%}
          <button class="cb-shop__category" data-category="{{ category | handleize }}">
            {{ category }}
          </button>
        {%- endif -%}
      {%- endfor -%}
    </div>

    {%- comment -%} Grid View - Horizontal scroll products {%- endcomment -%}
    <div class="cb-shop__products" data-shop-content="grid">
      {%- if collection != blank and collection.products.size > 0 -%}
        {%- for product in collection.products limit: 12 -%}
          {%- comment -%} Check if product is sold out (no variants available) {%- endcomment -%}
          {%- assign is_sold_out = true -%}
          {%- for variant in product.variants -%}
            {%- if variant.available -%}
              {%- assign is_sold_out = false -%}
              {%- break -%}
            {%- endif -%}
          {%- endfor -%}

          <div
            class="cb-shop__product{% if is_sold_out %} cb-shop__product--sold-out{% endif %}"
            {% unless is_sold_out %}data-action="shop-select-product"{% endunless %}
            data-product-id="{{ product.id }}"
            data-category="{{ product.type | handleize }}"
            tabindex="0"
            role="button"
            aria-label="{{ product.title }}{% if is_sold_out %}, sold out{% endif %}"
          >
            <div class="cb-shop__product-image">
              {%- comment -%} Image fallback placeholder {%- endcomment -%}
              <div class="cb-shop__product-placeholder" aria-hidden="true">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                  <circle cx="8.5" cy="8.5" r="1.5"/>
                  <path d="M21 15l-5-5L5 21"/>
                </svg>
              </div>
              {%- if product.featured_image != blank -%}
                <img
                  src="{{ product.featured_image | image_url: width: 400 }}"
                  alt="{{ product.title | escape }}"
                  loading="lazy"
                  class="cb-shop__product-img"
                  onerror="this.style.opacity='0'"
                >
              {%- endif -%}
              {%- comment -%} Creator Commission Badge - shown via JS when product has commission {%- endcomment -%}
              <span class="cb-shop__commission-badge" data-commission-badge style="display: none;">Creator Bonus</span>
              {%- if is_sold_out -%}
                <span class="cb-shop__sold-out-badge">Sold Out</span>
              {%- else -%}
                <button class="cb-shop__product-add" data-action="shop-quick-add" data-product-id="{{ product.id }}" aria-label="Quick add {{ product.title }}">+</button>
              {%- endif -%}
            </div>
            <p class="cb-shop__product-name">{{ product.title | truncate: 30 }}</p>
            <p class="cb-shop__product-price{% if is_sold_out %} cb-shop__product-price--sold-out{% endif %}" data-base-price="{{ product.price | money_without_currency | remove: ',' }}">
              {{ product.price | money }}
            </p>
            {%- comment -%} Embedded product data for JS {%- endcomment -%}
            <script type="application/json" class="cb-shop__product-data">
              {
                "id": {{ product.id | json }},
                "handle": {{ product.handle | json }},
                "title": {{ product.title | json }},
                "price": {{ product.price | divided_by: 100.0 }},
                "description": {{ product.description | strip_html | truncate: 500 | json }},
                "images": [
                  {%- for image in product.images limit: 4 -%}
                    "{{ image | image_url: width: 600 }}"{% unless forloop.last %},{% endunless %}
                  {%- endfor -%}
                ],
                "variants": [
                  {%- for variant in product.variants -%}
                    {
                      "id": {{ variant.id }},
                      "title": {{ variant.title | json }},
                      "option1": {{ variant.option1 | json }},
                      "available": {{ variant.available | json }},
                      "price": {{ variant.price | divided_by: 100.0 }}
                    }{% unless forloop.last %},{% endunless %}
                  {%- endfor -%}
                ]
              }
            </script>
          </div>
        {%- endfor -%}
      {%- else -%}
        <div style="text-align: center; color: #8B7D6B; padding: 40px 20px; width: 100%;">
          <p>No products available</p>
        </div>
      {%- endif -%}
    </div>

    {%- comment -%} Product View - Image Carousel {%- endcomment -%}
    <div class="cb-shop__product-view" data-shop-content="product" style="display: none;">
      <div class="cb-shop__carousel" data-shop-carousel>
        {%- comment -%} Carousel slides populated by JS {%- endcomment -%}
      </div>
      <div class="cb-shop__carousel-dots" data-shop-carousel-dots>
        {%- comment -%} Dots populated by JS {%- endcomment -%}
      </div>
      <div class="cb-shop__product-info">
        <div class="cb-shop__product-details">
          <p class="name" data-shop-product-title>Product Name</p>
          <p class="price" data-shop-product-price>$0.00</p>
        </div>
        <div class="cb-shop__sizes" data-shop-sizes>
          {%- comment -%} Size buttons populated by JS {%- endcomment -%}
        </div>
      </div>
    </div>

    {%- comment -%} Details View {%- endcomment -%}
    <div class="cb-shop__details-view" data-shop-content="details" style="display: none;">
      <div class="cb-shop__details-card">
        <div class="cb-shop__details-section">
          <h4>Description</h4>
          <p data-shop-description>Product description goes here...</p>
        </div>
        <div class="cb-shop__details-section">
          <h4>Size & Fit</h4>
          <p data-shop-sizefit>True to size. Model wears size M.</p>
        </div>
      </div>
    </div>

    {%- comment -%} Cart View {%- endcomment -%}
    <div class="cb-shop__cart-view" data-shop-content="cart" style="display: none;">
      <div class="cb-shop__cart-empty" data-shop-cart-empty>
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
          <path d="M6 6h15l-1.5 9h-12z"/>
          <circle cx="9" cy="20" r="1" fill="currentColor"/>
          <circle cx="18" cy="20" r="1" fill="currentColor"/>
          <path d="M6 6L5 3H2"/>
        </svg>
        <p>Your cart is empty</p>
        <button class="cb-shop__cart-empty-btn" data-action="shop-back-to-grid">Continue Shopping</button>
      </div>
      <div data-shop-cart-items>
        {%- comment -%} Cart items populated by JS {%- endcomment -%}
      </div>

      {%- comment -%} Checkout Footer - Only shows when cart has items {%- endcomment -%}
      <div class="cb-shop__checkout" data-shop-checkout style="display: none;">
        {%- comment -%} Cart Total {%- endcomment -%}
        <div class="cb-shop__checkout-total">
          <span>Total</span>
          <span data-shop-cart-total>$0.00</span>
        </div>

        {%- comment -%} Express Checkout Divider {%- endcomment -%}
        <div class="cb-shop__checkout-divider">
          <span>Express checkout</span>
        </div>

        {%- comment -%} Express Pay Buttons {%- endcomment -%}
        <div class="cb-shop__express-buttons">
          <button type="button" class="cb-shop__express-btn cb-shop__express-btn--apple" data-action="express-checkout" data-method="apple">
            <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
              <path d="M17.05 20.28c-.98.95-2.05.8-3.08.35-1.09-.46-2.09-.48-3.24 0-1.44.62-2.2.44-3.06-.35C2.79 15.25 3.51 7.59 9.05 7.31c1.35.07 2.29.74 3.08.8 1.18-.24 2.31-.93 3.57-.84 1.51.12 2.65.72 3.4 1.8-3.12 1.87-2.38 5.98.48 7.13-.57 1.5-1.31 2.99-2.54 4.09l.01-.01zM12.03 7.25c-.15-2.23 1.66-4.07 3.74-4.25.29 2.58-2.34 4.5-3.74 4.25z"/>
            </svg>
            <span>Pay</span>
          </button>
          <button type="button" class="cb-shop__express-btn cb-shop__express-btn--google" data-action="express-checkout" data-method="google">
            <svg viewBox="0 0 24 24" width="20" height="20">
              <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
              <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
              <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
              <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
            <span>Pay</span>
          </button>
          <button type="button" class="cb-shop__express-btn cb-shop__express-btn--shop" data-action="express-checkout" data-method="shop">
            <svg viewBox="0 0 20 20" fill="currentColor" width="18" height="18">
              <path d="M5.4 3.6L4 5v10.2c0 1 .8 1.8 1.8 1.8h8.4c1 0 1.8-.8 1.8-1.8V5l-1.4-1.4H5.4zM8 8c0 1.1.9 2 2 2s2-.9 2-2h1c0 1.7-1.3 3-3 3s-3-1.3-3-3h1z"/>
            </svg>
            <span>Shop Pay</span>
          </button>
        </div>

        {%- comment -%} Or Divider {%- endcomment -%}
        <div class="cb-shop__checkout-or">
          <span>or</span>
        </div>

        {%- comment -%} Regular Checkout Button {%- endcomment -%}
        <button type="button" class="cb-shop__checkout-btn" data-action="checkout">
          Checkout
        </button>
      </div>
    </div>
  </div>

  {%- comment -%} ========== BOTTOM TABS / SECTION HEADERS ========== {%- endcomment -%}
  {%- comment -%}
    Dynamic section ordering based on section_order variable.
    Default: socials, links, videos, music, exclusive, reviews
    Can be customized via metafield: creator_bio.section_order
    Tabs only appear if there's content for that section
  {%- endcomment -%}

  {%- comment -%} Determine which sections have content {%- endcomment -%}
  {%- assign has_socials = false -%}
  {%- if social_stats != blank or social_proof_cards != blank or instagram_url != blank or tiktok_url != blank or youtube_url != blank or twitter_url != blank -%}
    {%- assign has_socials = true -%}
  {%- endif -%}

  {%- assign has_links = false -%}
  {%- if links_json != blank -%}
    {%- assign parsed_links_check = links_json | parse_json -%}
    {%- if parsed_links_check.size > 0 -%}
      {%- assign has_links = true -%}
    {%- endif -%}
  {%- endif -%}

  {%- assign has_videos = false -%}
  {%- if videos_json != blank -%}
    {%- assign has_videos = true -%}
  {%- endif -%}

  {%- comment -%} Music: always show if in section_order, let content handle empty state {%- endcomment -%}
  {%- assign has_music = true -%}

  {%- comment -%} Exclusive and reviews - set to false until content exists {%- endcomment -%}
  {%- assign has_exclusive = false -%}
  {%- assign has_reviews = false -%}

  {%- if navigation_style == 'onepage' -%}
    {%- comment -%} ONE PAGE MODE - Show all sections in section_order {%- endcomment -%}
    {%- for section_name in section_order -%}
      {%- assign section_key = section_name | strip -%}

      {%- comment -%} Section Header {%- endcomment -%}
      <div class="cb-section-header">
        <h3 class="cb-section-title">
          {%- case section_key -%}
            {%- when 'socials' -%}Socials
            {%- when 'links' -%}Links
            {%- when 'videos' -%}Videos
            {%- when 'music' -%}{{ music_player_title | default: 'Music' }}
            {%- when 'exclusive' -%}Exclusive
            {%- when 'reviews' -%}Reviews
          {%- endcase -%}
        </h3>
      </div>

      {%- comment -%} Section Content {%- endcomment -%}
      <div class="cb-tab-content" data-tab-content="{{ section_key }}">
        {%- case section_key -%}
          {%- when 'socials' -%}
            {%- render 'cb-v2-social-cards',
              social_stats: social_stats,
              social_proof_cards: social_proof_cards,
              instagram_url: instagram_url,
              tiktok_url: tiktok_url,
              youtube_url: youtube_url,
              twitter_url: twitter_url
            -%}

          {%- when 'links' -%}
            {%- if links_json != blank -%}
              {%- assign parsed_links = links_json | parse_json -%}
              {%- if parsed_links.size > 0 -%}
                <div class="cb-links-list">
                  {%- for link in parsed_links -%}
                    {%- assign link_url = link.url -%}
                    {%- unless link_url contains 'http://' or link_url contains 'https://' -%}
                      {%- assign link_url = link_url | prepend: 'https://' -%}
                    {%- endunless -%}
                    <a href="{{ link_url }}" class="cb-link-card" target="_blank" rel="noopener">
                      <span class="cb-link-card__title">{{ link.title }}</span>
                      <svg class="cb-link-card__arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M7 17L17 7M17 7H7M17 7V17"/>
                      </svg>
                    </a>
                  {%- endfor -%}
                </div>
              {%- else -%}
                <div class="cb-empty-state cb-empty-state--small"><p>No links added yet.</p></div>
              {%- endif -%}
            {%- else -%}
              <div class="cb-empty-state cb-empty-state--small"><p>No links added yet.</p></div>
            {%- endif -%}

          {%- when 'videos' -%}
            {%- render 'cb-v2-videos', videos_json: videos_json -%}

          {%- when 'music' -%}
            {%- render 'cb-v2-music-player',
              enable_music_player: true,
              music_player_title: '',
              music_player_theme: music_player_theme,
              music_items: music_items
            -%}

          {%- when 'exclusive' -%}
            <div class="cb-empty-state cb-empty-state--small"><p>Exclusive content coming soon.</p></div>

          {%- when 'reviews' -%}
            <div class="cb-empty-state cb-empty-state--small"><p>Reviews coming soon.</p></div>
        {%- endcase -%}
      </div>
    {%- endfor -%}

  {%- else -%}
    {%- comment -%} TABS MODE - Only show tabs with content {%- endcomment -%}
    {%- assign first_tab_set = false -%}
    <div class="cb-bottom-tabs">
      {%- for section_name in section_order -%}
        {%- assign section_key = section_name | strip -%}
        {%- assign show_tab = false -%}

        {%- comment -%} Check if section has content {%- endcomment -%}
        {%- case section_key -%}
          {%- when 'socials' -%}{%- if has_socials -%}{%- assign show_tab = true -%}{%- endif -%}
          {%- when 'links' -%}{%- if has_links -%}{%- assign show_tab = true -%}{%- endif -%}
          {%- when 'videos' -%}{%- if has_videos -%}{%- assign show_tab = true -%}{%- endif -%}
          {%- when 'music' -%}{%- if has_music -%}{%- assign show_tab = true -%}{%- endif -%}
          {%- when 'exclusive' -%}{%- if has_exclusive -%}{%- assign show_tab = true -%}{%- endif -%}
          {%- when 'reviews' -%}{%- if has_reviews -%}{%- assign show_tab = true -%}{%- endif -%}
        {%- endcase -%}

        {%- if show_tab -%}
          <button class="cb-bottom-tab{% unless first_tab_set %} active{% assign first_tab_set = true %}{% endunless %}" data-tab="{{ section_key }}">
            {%- case section_key -%}
              {%- when 'socials' -%}SOCIALS
              {%- when 'links' -%}LINKS
              {%- when 'videos' -%}VIDEOS
              {%- when 'music' -%}MUSIC
              {%- when 'exclusive' -%}EXCLUSIVE
              {%- when 'reviews' -%}REVIEWS
            {%- endcase -%}
          </button>
        {%- endif -%}
      {%- endfor -%}
    </div>

    {%- comment -%} Tab Content - Only render sections with content {%- endcomment -%}
    {%- assign first_content_set = false -%}
    {%- for section_name in section_order -%}
      {%- assign section_key = section_name | strip -%}
      {%- assign show_content = false -%}

      {%- comment -%} Check if section has content {%- endcomment -%}
      {%- case section_key -%}
        {%- when 'socials' -%}{%- if has_socials -%}{%- assign show_content = true -%}{%- endif -%}
        {%- when 'links' -%}{%- if has_links -%}{%- assign show_content = true -%}{%- endif -%}
        {%- when 'videos' -%}{%- if has_videos -%}{%- assign show_content = true -%}{%- endif -%}
        {%- when 'music' -%}{%- if has_music -%}{%- assign show_content = true -%}{%- endif -%}
        {%- when 'exclusive' -%}{%- if has_exclusive -%}{%- assign show_content = true -%}{%- endif -%}
        {%- when 'reviews' -%}{%- if has_reviews -%}{%- assign show_content = true -%}{%- endif -%}
      {%- endcase -%}

      {%- if show_content -%}
        <div class="cb-tab-content" data-tab-content="{{ section_key }}"{% if first_content_set %} style="display: none;"{% endif %}>
          {%- unless first_content_set -%}{%- assign first_content_set = true -%}{%- endunless -%}
          {%- case section_key -%}
            {%- when 'socials' -%}
              {%- render 'cb-v2-social-cards',
                social_stats: social_stats,
                social_proof_cards: social_proof_cards,
                instagram_url: instagram_url,
                tiktok_url: tiktok_url,
                youtube_url: youtube_url,
                twitter_url: twitter_url
              -%}

            {%- when 'links' -%}
              {%- assign parsed_links = links_json | parse_json -%}
              <div class="cb-links-list">
                {%- for link in parsed_links -%}
                  {%- assign link_url = link.url -%}
                  {%- unless link_url contains 'http://' or link_url contains 'https://' -%}
                    {%- assign link_url = link_url | prepend: 'https://' -%}
                  {%- endunless -%}
                  <a href="{{ link_url }}" class="cb-link-card" target="_blank" rel="noopener">
                    <span class="cb-link-card__title">{{ link.title }}</span>
                    <svg class="cb-link-card__arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                      <path d="M7 17L17 7M17 7H7M17 7V17"/>
                    </svg>
                  </a>
                {%- endfor -%}
              </div>

            {%- when 'videos' -%}
              {%- render 'cb-v2-videos', videos_json: videos_json -%}

            {%- when 'music' -%}
              {%- render 'cb-v2-music-player',
                enable_music_player: true,
                music_player_title: '',
                music_player_theme: music_player_theme,
                music_items: music_items
              -%}

            {%- when 'exclusive' -%}
              {%- comment -%} Exclusive content here {%- endcomment -%}

            {%- when 'reviews' -%}
              {%- comment -%} Reviews content here {%- endcomment -%}
          {%- endcase -%}
        </div>
      {%- endif -%}
    {%- endfor -%}
  {%- endif -%}

</div>
