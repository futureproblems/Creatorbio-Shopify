{%- comment -%}
  CB Commerce V2 - Videos Component
  Clean format-based layout: Landscape (YouTube, Vimeo) + Portrait (Shorts, TikTok)
  No platform headings, no Instagram (unreliable embeds)
{%- endcomment -%}

{%- if videos_json != blank -%}
  {%- assign videos = videos_json | parse_json -%}
{%- else -%}
  {%- assign videos = nil -%}
{%- endif -%}

{%- if videos != blank and videos.size > 0 -%}
  {%- comment -%} Separate videos by format {%- endcomment -%}
  {%- assign landscape_videos = '' -%}
  {%- assign portrait_videos = '' -%}

  {%- for video in videos -%}
    {%- case video.platform -%}
      {%- when 'youtube' or 'vimeo' -%}
        {%- if landscape_videos == '' -%}
          {%- assign landscape_videos = video.platform | append: '::' | append: video.url -%}
        {%- else -%}
          {%- assign landscape_videos = landscape_videos | append: '|||' | append: video.platform | append: '::' | append: video.url -%}
        {%- endif -%}
      {%- when 'youtube_shorts' or 'tiktok' -%}
        {%- if portrait_videos == '' -%}
          {%- assign portrait_videos = video.platform | append: '::' | append: video.url -%}
        {%- else -%}
          {%- assign portrait_videos = portrait_videos | append: '|||' | append: video.platform | append: '::' | append: video.url -%}
        {%- endif -%}
    {%- endcase -%}
  {%- endfor -%}

  <div class="cb-videos">

    {%- comment -%} ========== LANDSCAPE VIDEOS ========== {%- endcomment -%}
    {%- if landscape_videos != '' -%}
      {%- assign landscape_array = landscape_videos | split: '|||' -%}
      <div class="cb-videos__landscape">
        {%- for item in landscape_array -%}
          {%- assign parts = item | split: '::' -%}
          {%- assign platform = parts[0] -%}
          {%- assign video_url = parts[1] -%}
          {%- assign video_id = '' -%}

          {%- if platform == 'youtube' -%}
            {%- if video_url contains 'youtube.com/watch' -%}
              {%- assign video_id = video_url | split: 'v=' | last | split: '&' | first -%}
            {%- elsif video_url contains 'youtu.be/' -%}
              {%- assign video_id = video_url | split: 'youtu.be/' | last | split: '?' | first -%}
            {%- endif -%}
            {%- if video_id != blank -%}
              <div class="cb-video cb-video--landscape">
                <iframe
                  src="https://www.youtube.com/embed/{{ video_id }}"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                  allowfullscreen
                  loading="lazy"
                  title="Video"
                ></iframe>
              </div>
            {%- endif -%}
          {%- elsif platform == 'vimeo' -%}
            {%- if video_url contains 'vimeo.com/' -%}
              {%- assign video_id = video_url | split: 'vimeo.com/' | last | split: '?' | first | split: '/' | first -%}
            {%- endif -%}
            {%- if video_id != blank -%}
              <div class="cb-video cb-video--landscape">
                <iframe
                  src="https://player.vimeo.com/video/{{ video_id }}"
                  allow="autoplay; fullscreen; picture-in-picture"
                  allowfullscreen
                  loading="lazy"
                  title="Video"
                ></iframe>
              </div>
            {%- endif -%}
          {%- endif -%}
        {%- endfor -%}
      </div>
    {%- endif -%}

    {%- comment -%} ========== PORTRAIT VIDEOS ========== {%- endcomment -%}
    {%- if portrait_videos != '' -%}
      {%- assign portrait_array = portrait_videos | split: '|||' -%}

      <div class="cb-videos__portrait">
        {%- for item in portrait_array -%}
          {%- assign parts = item | split: '::' -%}
          {%- assign platform = parts[0] -%}
          {%- assign video_url = parts[1] -%}
          {%- assign video_id = '' -%}

          {%- if platform == 'youtube_shorts' -%}
            {%- if video_url contains '/shorts/' -%}
              {%- assign video_id = video_url | split: '/shorts/' | last | split: '?' | first -%}
            {%- endif -%}
            {%- if video_id != blank -%}
              <div class="cb-video cb-video--portrait">
                <iframe
                  src="https://www.youtube.com/embed/{{ video_id }}"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                  allowfullscreen
                  loading="lazy"
                  title="Video"
                ></iframe>
              </div>
            {%- endif -%}
          {%- elsif platform == 'tiktok' -%}
            <a href="{{ video_url }}" target="_blank" rel="noopener" class="cb-video cb-video--portrait cb-video--tiktok-link">
              <div class="cb-video__tiktok-icon">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-5.2 1.74 2.89 2.89 0 0 1 2.31-4.64 2.93 2.93 0 0 1 .88.13V9.4a6.84 6.84 0 0 0-1-.05A6.33 6.33 0 0 0 5 20.1a6.34 6.34 0 0 0 10.86-4.43v-7a8.16 8.16 0 0 0 4.77 1.52v-3.4a4.85 4.85 0 0 1-1-.1z"/>
                </svg>
              </div>
              <span class="cb-video__tiktok-label">Watch on TikTok</span>
            </a>
          {%- endif -%}
        {%- endfor -%}
      </div>

    {%- endif -%}

  </div>
{%- else -%}
  <div class="cb-empty-state cb-empty-state--small">
    <p>No videos yet.</p>
  </div>
{%- endif -%}
