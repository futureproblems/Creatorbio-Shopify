{%- comment -%}
  CB Commerce V2 - Videos Component
  Displays embedded videos from YouTube, TikTok, and Instagram Reels
  Styling matched to creatorb-app TikTokVideoCard component
{%- endcomment -%}

{%- if videos_json != blank -%}
  {%- assign videos = videos_json | parse_json -%}
{%- else -%}
  {%- assign videos = nil -%}
{%- endif -%}

{%- if videos != blank and videos.size > 0 -%}
  {%- assign youtube_videos = '' -%}
  {%- assign tiktok_videos = '' -%}
  {%- assign instagram_videos = '' -%}

  {%- for video in videos -%}
    {%- if video.platform == 'youtube' or video.platform == 'youtube_shorts' -%}
      {%- if youtube_videos == '' -%}
        {%- assign youtube_videos = video.url -%}
      {%- else -%}
        {%- assign youtube_videos = youtube_videos | append: '|||' | append: video.url -%}
      {%- endif -%}
    {%- elsif video.platform == 'tiktok' -%}
      {%- if tiktok_videos == '' -%}
        {%- assign tiktok_videos = video.url -%}
      {%- else -%}
        {%- assign tiktok_videos = tiktok_videos | append: '|||' | append: video.url -%}
      {%- endif -%}
    {%- elsif video.platform == 'instagram_reels' or video.platform == 'instagram' -%}
      {%- if instagram_videos == '' -%}
        {%- assign instagram_videos = video.url -%}
      {%- else -%}
        {%- assign instagram_videos = instagram_videos | append: '|||' | append: video.url -%}
      {%- endif -%}
    {%- endif -%}
  {%- endfor -%}

  <div class="cb-videos">

    {%- comment -%} ========== YOUTUBE VIDEOS ========== {%- endcomment -%}
    {%- if youtube_videos != '' -%}
      {%- assign youtube_array = youtube_videos | split: '|||' -%}
      <div class="cb-videos__section">
        <h4 class="cb-videos__heading">YouTube</h4>
        <div class="cb-videos__grid">
          {%- for video_url in youtube_array -%}
            {%- assign embed_url = '' -%}
            {%- assign video_id = '' -%}

            {%- if video_url contains 'youtube.com/shorts/' -%}
              {%- assign video_id = video_url | split: '/shorts/' | last | split: '?' | first -%}
            {%- elsif video_url contains 'youtube.com/watch' -%}
              {%- assign video_id = video_url | split: 'v=' | last | split: '&' | first -%}
            {%- elsif video_url contains 'youtu.be/' -%}
              {%- assign video_id = video_url | split: 'youtu.be/' | last | split: '?' | first -%}
            {%- endif -%}

            {%- if video_id != blank -%}
              {%- assign embed_url = 'https://www.youtube.com/embed/' | append: video_id | append: '?modestbranding=1&rel=0' -%}
            {%- endif -%}

            {%- if embed_url != blank -%}
              <div class="cb-video-card cb-video-card--youtube">
                <div class="cb-video-card__inner">
                  <iframe
                    src="{{ embed_url }}"
                    class="cb-video-card__iframe"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen
                    loading="lazy"
                    title="YouTube video"
                  ></iframe>
                </div>
              </div>
            {%- endif -%}
          {%- endfor -%}
        </div>
      </div>
    {%- endif -%}

    {%- comment -%} ========== TIKTOK ========== {%- endcomment -%}
    {%- if tiktok_videos != '' -%}
      {%- assign tiktok_array = tiktok_videos | split: '|||' -%}
      <script async src="https://www.tiktok.com/embed.js"></script>

      <div class="cb-videos__section">
        <h4 class="cb-videos__heading">TikTok</h4>
        <div class="cb-videos__stack">
          {%- for video_url in tiktok_array -%}
            {%- assign video_id = '' -%}
            {%- if video_url contains '/video/' -%}
              {%- assign video_id = video_url | split: '/video/' | last | split: '?' | first -%}
            {%- endif -%}

            {%- if video_id != blank -%}
              <div class="cb-video-card cb-video-card--tiktok">
                <div class="cb-video-card__inner">
                  <div class="cb-video-card__loading">
                    <div class="cb-video-card__shimmer"></div>
                  </div>
                  <blockquote
                    class="tiktok-embed"
                    cite="{{ video_url }}"
                    data-video-id="{{ video_id }}"
                  >
                    <section style="display:none;">
                      <a target="_blank" href="{{ video_url }}" rel="noopener">View on TikTok</a>
                    </section>
                  </blockquote>
                </div>
              </div>
            {%- endif -%}
          {%- endfor -%}
        </div>
      </div>
    {%- endif -%}

    {%- comment -%} ========== INSTAGRAM REELS ========== {%- endcomment -%}
    {%- if instagram_videos != '' -%}
      {%- assign instagram_array = instagram_videos | split: '|||' -%}
      <div class="cb-videos__section">
        <h4 class="cb-videos__heading">Reels</h4>
        <div class="cb-videos__stack">
          {%- for ig_url in instagram_array -%}
            {%- assign embed_url = '' -%}
            {%- if ig_url contains '/reel/' -%}
              {%- assign video_id = ig_url | split: '/reel/' | last | split: '/' | first | split: '?' | first -%}
              {%- assign embed_url = 'https://www.instagram.com/reel/' | append: video_id | append: '/embed/' -%}
            {%- elsif ig_url contains '/p/' -%}
              {%- assign video_id = ig_url | split: '/p/' | last | split: '/' | first | split: '?' | first -%}
              {%- assign embed_url = 'https://www.instagram.com/p/' | append: video_id | append: '/embed/' -%}
            {%- endif -%}

            {%- if embed_url != blank -%}
              <div class="cb-video-card cb-video-card--instagram">
                <div class="cb-video-card__inner">
                  <iframe
                    src="{{ embed_url }}"
                    class="cb-video-card__iframe"
                    frameborder="0"
                    scrolling="no"
                    allowtransparency="true"
                    allowfullscreen
                    loading="lazy"
                    title="Instagram Reel"
                  ></iframe>
                </div>
              </div>
            {%- endif -%}
          {%- endfor -%}
        </div>
      </div>
    {%- endif -%}

  </div>
{%- endif -%}

<style>
  /* ========================================
     CB Commerce V2 - Videos Styles
     Matching creatorb-app TikTokVideoCard
  ======================================== */

  @keyframes shimmer {
    0% { background-position: -200% 0; }
    100% { background-position: 200% 0; }
  }

  .cb-videos {
    padding: 0;
  }

  .cb-videos__section {
    margin-bottom: 32px;
  }

  .cb-videos__section:last-child {
    margin-bottom: 0;
  }

  /* Section Headings - Playfair Display italic */
  .cb-videos__heading {
    display: block;
    font-family: 'Playfair Display', Georgia, serif;
    font-size: 20px;
    font-weight: 500;
    font-style: italic;
    color: var(--cb-text-primary, #1a1a1a);
    text-align: center;
    margin: 0 0 20px 0;
    padding: 24px 0 0 0;
    letter-spacing: 0.01em;
  }

  /* Grid for YouTube (landscape) */
  .cb-videos__grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 16px;
  }

  /* Stacked layout for portrait videos (centered) */
  .cb-videos__stack {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
    padding: 8px 0;
  }

  /* ========================================
     Video Card Base - Glassmorphism Style
  ======================================== */
  .cb-video-card {
    position: relative;
    border-radius: 16px;
    overflow: hidden;
    /* Glassmorphism matching TikTokVideoCard.tsx */
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    padding: 8px;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .cb-video-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
  }

  /* Inner wrapper with smaller radius */
  .cb-video-card__inner {
    position: relative;
    width: 100%;
    height: 100%;
    border-radius: 12px;
    overflow: hidden;
    background: #000;
  }

  .cb-video-card__iframe {
    width: 100%;
    height: 100%;
    border: none;
    display: block;
  }

  /* Loading skeleton for TikTok */
  .cb-video-card__loading {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
    z-index: 10;
    pointer-events: none;
  }

  .cb-video-card__shimmer {
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05), transparent);
    background-size: 200% 100%;
    animation: shimmer 2s infinite;
  }

  /* ========================================
     YouTube - Landscape 16:9
  ======================================== */
  .cb-video-card--youtube {
    width: 100%;
  }

  .cb-video-card--youtube .cb-video-card__inner {
    aspect-ratio: 16/9;
  }

  /* ========================================
     TikTok - Portrait 9:16 (smaller for commerce)
  ======================================== */
  .cb-video-card--tiktok {
    width: 200px;
    height: 355px;
  }

  .cb-video-card--tiktok .cb-video-card__inner {
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  /* TikTok embed overrides */
  .cb-video-card--tiktok blockquote.tiktok-embed {
    margin: 0 !important;
    padding: 0 !important;
    width: 100% !important;
    height: 100% !important;
    border: none !important;
    border-radius: 0 !important;
    box-shadow: none !important;
    background: transparent !important;
  }

  .cb-video-card--tiktok blockquote.tiktok-embed iframe {
    width: 100% !important;
    height: 100% !important;
    border: none !important;
    border-radius: 10px !important;
  }

  /* Hide loading when TikTok loads */
  .cb-video-card--tiktok:has(iframe) .cb-video-card__loading {
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  /* ========================================
     Instagram Reels - Portrait 9:16 (smaller)
  ======================================== */
  .cb-video-card--instagram {
    width: 200px;
    height: 355px;
  }

  .cb-video-card--instagram .cb-video-card__inner {
    height: 100%;
  }

  /* Crop Instagram embed to hide header/footer */
  .cb-video-card--instagram .cb-video-card__iframe {
    width: 100%;
    height: 115%;
    transform: translateY(-7%);
    object-fit: cover;
  }

  /* ========================================
     Mobile Adjustments (smaller screens)
  ======================================== */
  @media (max-width: 400px) {
    .cb-videos__heading {
      font-size: 18px;
      padding-top: 20px;
      margin-bottom: 16px;
    }

    .cb-videos__stack {
      gap: 12px;
    }

    .cb-video-card {
      padding: 6px;
    }

    .cb-video-card--tiktok,
    .cb-video-card--instagram {
      width: 180px;
      height: 320px;
    }

    .cb-video-card__inner {
      border-radius: 10px;
    }
  }
</style>
