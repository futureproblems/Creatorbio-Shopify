{%- comment -%}
  CB Commerce V2 - Videos Component
  Displays embedded videos from YouTube, TikTok, and Instagram Reels
  Clean, aesthetic implementation focusing on the video content.
{%- endcomment -%}

{%- if videos_json != blank -%}
  {%- assign videos = videos_json | parse_json -%}
{%- else -%}
  {%- assign videos = nil -%}
{%- endif -%}

{%- if videos != blank and videos.size > 0 -%}
  {%- assign youtube_videos = '' -%}
  {%- assign youtube_shorts_videos = '' -%}
  {%- assign tiktok_videos = '' -%}
  {%- assign instagram_videos = '' -%}

  {%- for video in videos -%}
    {%- if video.platform == 'youtube' -%}
      {%- if youtube_videos == '' -%}
        {%- assign youtube_videos = video.url -%}
      {%- else -%}
        {%- assign youtube_videos = youtube_videos | append: '|||' | append: video.url -%}
      {%- endif -%}
    {%- elsif video.platform == 'youtube_shorts' -%}
      {%- if youtube_shorts_videos == '' -%}
        {%- assign youtube_shorts_videos = video.url -%}
      {%- else -%}
        {%- assign youtube_shorts_videos = youtube_shorts_videos | append: '|||' | append: video.url -%}
      {%- endif -%}
    {%- elsif video.platform == 'tiktok' -%}
      {%- if tiktok_videos == '' -%}
        {%- assign tiktok_videos = video.url -%}
      {%- else -%}
        {%- assign tiktok_videos = tiktok_videos | append: '|||' | append: video.url -%}
      {%- endif -%}
    {%- elsif video.platform == 'instagram_reels' or video.platform == 'instagram' -%}
      {%- if instagram_videos == '' -%}
        {%- assign instagram_videos = video.url -%}
      {%- else -%}
        {%- assign instagram_videos = instagram_videos | append: '|||' | append: video.url -%}
      {%- endif -%}
    {%- endif -%}
  {%- endfor -%}

  <div class="cb-videos">

    {%- comment -%} ========== YOUTUBE VIDEOS ========== {%- endcomment -%}
    {%- if youtube_videos != '' -%}
      {%- assign youtube_array = youtube_videos | split: '|||' -%}
      <div class="cb-videos__section">
        <h4 class="cb-videos__heading">YouTube</h4>
        <div class="cb-videos__grid cb-videos__grid--landscape">
          {%- for video_url in youtube_array -%}
            {%- assign embed_url = '' -%}
            {%- if video_url contains 'youtube.com/watch' -%}
              {%- assign video_id = video_url | split: 'v=' | last | split: '&' | first -%}
              {%- assign embed_url = 'https://www.youtube.com/embed/' | append: video_id | append: '?modestbranding=1&controls=1&rel=0' -%}
            {%- elsif video_url contains 'youtu.be/' -%}
              {%- assign video_id = video_url | split: 'youtu.be/' | last | split: '?' | first -%}
              {%- assign embed_url = 'https://www.youtube.com/embed/' | append: video_id | append: '?modestbranding=1&controls=1&rel=0' -%}
            {%- endif -%}

            {%- if embed_url != blank -%}
              <div class="cb-video-card cb-video-card--landscape">
                <div class="cb-video-card__wrapper">
                  <iframe
                    src="{{ embed_url }}"
                    class="cb-video-card__iframe"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen
                    loading="lazy"
                    title="YouTube video"
                  ></iframe>
                </div>
              </div>
            {%- endif -%}
          {%- endfor -%}
        </div>
      </div>
    {%- endif -%}

    {%- comment -%} ========== TIKTOK ========== {%- endcomment -%}
    {%- if tiktok_videos != '' -%}
      {%- assign tiktok_array = tiktok_videos | split: '|||' -%}
      {%- comment -%} Load TikTok SDK once {%- endcomment -%}
      <script async src="https://www.tiktok.com/embed.js"></script>
      
      <div class="cb-videos__section">
        <h4 class="cb-videos__heading">TikTok</h4>
        <div class="cb-videos__carousel">
          {%- for video_url in tiktok_array -%}
            {%- assign video_id = '' -%}
            {%- if video_url contains '/video/' -%}
              {%- assign video_id = video_url | split: '/video/' | last | split: '?' | first -%}
            {%- endif -%}

            {%- if video_id != blank -%}
              <div class="cb-video-card cb-video-card--portrait cb-video-card--tiktok">
                <div class="cb-video-card__wrapper">
                  {%- comment -%} 
                    Using the Blockquote method is standard for TikTok to render 
                    cleaner native players than the pure iframe method.
                  {%- endcomment -%}
                  <blockquote 
                    class="tiktok-embed" 
                    cite="{{ video_url }}" 
                    data-video-id="{{ video_id }}" 
                    style="max-width: 605px;min-width: 325px;" >
                    <section>
                      <a target="_blank" href="{{ video_url }}">@tiktok</a>
                    </section>
                  </blockquote>
                </div>
              </div>
            {%- endif -%}
          {%- endfor -%}
        </div>
      </div>
    {%- endif -%}

    {%- comment -%} ========== INSTAGRAM REELS ========== {%- endcomment -%}
    {%- if instagram_videos != '' -%}
      {%- assign instagram_array = instagram_videos | split: '|||' -%}
      <div class="cb-videos__section">
        <h4 class="cb-videos__heading">Reels</h4>
        <div class="cb-videos__carousel">
          {%- for ig_url in instagram_array -%}
            {%- assign embed_url = '' -%}
            {%- if ig_url contains '/reel/' -%}
              {%- assign video_id = ig_url | split: '/reel/' | last | split: '/' | first | split: '?' | first -%}
              {%- assign embed_url = 'https://www.instagram.com/reel/' | append: video_id | append: '/embed/' -%}
            {%- elsif ig_url contains '/p/' -%}
              {%- assign video_id = ig_url | split: '/p/' | last | split: '/' | first | split: '?' | first -%}
              {%- assign embed_url = 'https://www.instagram.com/p/' | append: video_id | append: '/embed/' -%}
            {%- endif -%}

            {%- if embed_url != blank -%}
              <div class="cb-video-card cb-video-card--portrait cb-video-card--instagram">
                 <div class="cb-video-card__wrapper">
                  <iframe
                    src="{{ embed_url }}"
                    class="cb-video-card__iframe"
                    frameborder="0"
                    scrolling="no"
                    allowtransparency="true"
                    allowfullscreen
                    loading="lazy"
                    title="Instagram Reel"
                  ></iframe>
                  {%- comment -%} Overlay to block captions/chrome clicks if desired, optional {%- endcomment -%}
                  <div class="cb-click-shield"></div>
                </div>
              </div>
            {%- endif -%}
          {%- endfor -%}
        </div>
      </div>
    {%- endif -%}

  </div>
{%- endif -%}

<style>
  /* --- Layout & Typography --- */
  .cb-videos { padding: 0; }
  .cb-videos__section { margin-bottom: 24px; }
  .cb-videos__section:last-child { margin-bottom: 0; }
  
  .cb-videos__heading {
    display: block;
    font-family: 'Playfair Display', serif;
    font-size: 20px;
    font-style: italic;
    text-align: center;
    margin: 0 0 16px 0;
    padding-top: 16px;
  }

  .cb-videos__grid { display: grid; gap: 12px; }
  .cb-videos__grid--landscape { grid-template-columns: 1fr; }
  
  .cb-videos__carousel {
    display: flex;
    gap: 12px;
    overflow-x: auto;
    overflow-y: hidden;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 8px; /* Space for scrollbar if visible */
    scrollbar-width: none;
  }
  .cb-videos__carousel::-webkit-scrollbar { display: none; }

  /* --- Card Base Styles --- */
  .cb-video-card {
    position: relative;
    border-radius: 16px;
    overflow: hidden;
    background: #000; /* Fallback */
    /* Glassmorphism effect based on your React reference */
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    
    transition: transform 0.3s ease;
  }

  .cb-video-card:hover {
    transform: translateY(-2px);
  }

  .cb-video-card__wrapper {
    position: relative;
    width: 100%;
    height: 100%;
    border-radius: 12px; /* Inner radius slightly smaller */
    overflow: hidden;
  }

  .cb-video-card__iframe {
    width: 100%;
    height: 100%;
    border: none;
    display: block;
  }

  /* --- Specific Sizes --- */
  
  /* Landscape (YouTube) */
  .cb-video-card--landscape {
    width: 100%;
    aspect-ratio: 16/9;
  }

  /* Portrait (TikTok/Reels/Shorts) */
  .cb-video-card--portrait {
    flex: 0 0 325px;
    width: 325px;
    height: 575px;
    scroll-snap-align: center;
  }

  /* --- Platform Specific Hacks for Cleanliness --- */

  /* Instagram */
  .cb-video-card--instagram .cb-video-card__iframe {
    /* Transform to scale up and crop out the header/footer of the IG embed */
    width: 100%;
    height: 115%; /* Make it taller than container */
    transform: translateY(-7%); /* Shift it up to center the video content */
    object-fit: cover;
  }

  /* TikTok Clean Up */
  .cb-video-card--tiktok .cb-video-card__wrapper {
    display: flex;
    justify-content: center;
    align-items: center;
    background: #000;
  }
  
  /* Force the TikTok blockquote to fill the container without margin */
  .cb-video-card--tiktok blockquote.tiktok-embed {
    margin: 0 !important;
    border: none !important;
    border-radius: 0 !important;
    box-shadow: none !important;
    min-width: 100% !important;
    width: 100% !important;
  }

  /* Hide the TikTok footer/header using negative margins or scaling if needed 
     Note: TikTok is harder to crop safely than IG due to dynamic heights, 
     but the black background helps hide gaps. */

  /* Mobile Adjustments */
  @media (max-width: 480px) {
    .cb-video-card--portrait {
      flex: 0 0 280px;
      width: 280px;
      height: 500px;
    }
  }
</style>