{%- comment -%}
  Creator Bio Commerce V2 - Main Section
  Component-based architecture with view state management
  States: browse → product → details → cart
{%- endcomment -%}

{%- comment -%} ========================================
  METAFIELD PARSING - Existing Fields
======================================== {%- endcomment -%}

{%- assign links_json = page.metafields.creator_bio.links_json.value -%}
{%- assign avatar_url = page.metafields.creator_bio.avatar_url.value -%}
{%- assign hide_avatar = page.metafields.creator_bio.hide_avatar.value -%}
{%- assign banner_image_url = page.metafields.creator_bio.banner_image_url.value -%}
{%- assign full_name = page.metafields.creator_bio.full_name.value -%}
{%- assign username = page.metafields.creator_bio.username.value -%}
{%- assign user_id = page.metafields.creator_bio.user_id.value -%}
{%- assign bio = page.metafields.creator_bio.bio.value -%}
{%- assign collection_handle = page.metafields.creator_bio.collection_handle.value -%}
{%- assign videos_json = page.metafields.creator_bio.videos_json.value -%}

{%- comment -%} Parse socials JSON {%- endcomment -%}
{%- assign socials = page.metafields.creator_bio.socials_json.value -%}
{%- if socials != blank -%}
  {%- assign instagram_url = socials.instagram -%}
  {%- assign twitter_url = socials.twitter -%}
  {%- assign facebook_url = socials.facebook -%}
  {%- assign youtube_url = socials.youtube -%}
  {%- assign tiktok_url = socials.tiktok -%}
  {%- assign linkedin_url = socials.linkedin -%}
  {%- assign email_url = socials.email -%}
  {%- assign snapchat_url = socials.snapchat -%}
  {%- assign amazon_url = socials.amazon -%}
{%- endif -%}

{%- comment -%} Email signup settings {%- endcomment -%}
{%- assign email_signup_settings = page.metafields.creator_bio.email_signup_settings.value -%}
{%- if email_signup_settings != blank -%}
  {%- assign enable_email_signup = email_signup_settings.enabled -%}
  {%- assign email_signup_title = email_signup_settings.title -%}
  {%- assign email_signup_description = email_signup_settings.description -%}
{%- else -%}
  {%- assign enable_email_signup = true -%}
{%- endif -%}

{%- comment -%} Music player settings {%- endcomment -%}
{%- assign enable_music_player_raw = page.metafields.creator_bio.enable_music_player.value -%}
{%- if enable_music_player_raw == 'true' or enable_music_player_raw == true -%}
  {%- assign enable_music_player = true -%}
{%- else -%}
  {%- assign enable_music_player = false -%}
{%- endif -%}
{%- assign music_player_title = page.metafields.creator_bio.music_player_title.value -%}
{%- assign music_player_theme = page.metafields.creator_bio.music_player_theme.value | default: 'auto' -%}
{%- assign music_items = page.metafields.creator_bio.music_items.value -%}

{%- comment -%} ========================================
  NEW V2 METAFIELDS
======================================== {%- endcomment -%}

{%- assign b_score = page.metafields.creator_bio.b_score.value | default: 0 -%}
{%- assign b_score_reviews = page.metafields.creator_bio.b_score_reviews.value | default: 0 -%}
{%- assign creator_tags = page.metafields.creator_bio.creator_tags.value -%}
{%- assign social_stats = page.metafields.creator_bio.social_stats.value -%}

{%- comment -%} Parse social proof cards (video embeds) {%- endcomment -%}
{%- assign social_proof_cards = page.metafields.creator_bio.social_proof_cards.value -%}

{%- comment -%} ========================================
  V2 LAYOUT SETTINGS (from metafields, with section.settings fallback)
======================================== {%- endcomment -%}

{%- assign text_alignment = page.metafields.creator_bio.text_alignment.value | default: section.settings.text_alignment | default: 'left' -%}
{%- assign name_single_line_raw = page.metafields.creator_bio.name_single_line.value -%}
{%- if name_single_line_raw == 'true' -%}
  {%- assign name_single_line = true -%}
{%- elsif name_single_line_raw == 'false' -%}
  {%- assign name_single_line = false -%}
{%- else -%}
  {%- assign name_single_line = section.settings.name_single_line | default: false -%}
{%- endif -%}
{%- assign navigation_style = page.metafields.creator_bio.navigation_style.value | default: section.settings.navigation_style | default: 'tabs' -%}
{%- assign bg_primary = page.metafields.creator_bio.bg_primary.value | default: section.settings.bg_primary | default: '#D4C4A8' -%}
{%- assign bg_secondary = page.metafields.creator_bio.bg_secondary.value | default: section.settings.bg_secondary | default: '#C9B896' -%}
{%- assign text_dark = page.metafields.creator_bio.text_dark.value | default: section.settings.text_dark | default: '#3C3226' -%}
{%- assign accent_color = page.metafields.creator_bio.accent_color.value | default: section.settings.accent_color | default: '#1A1A1A' -%}

{%- comment -%} ========================================
  DERIVED VALUES
======================================== {%- endcomment -%}

{%- comment -%} Determine creator name {%- endcomment -%}
{%- assign creator_name = '' -%}
{%- if full_name != blank and full_name.size > 0 -%}
  {%- assign creator_name = full_name -%}
{%- elsif username != blank and username.size > 0 -%}
  {%- assign creator_name = username -%}
{%- elsif section.settings.creator_name != blank -%}
  {%- assign creator_name = section.settings.creator_name -%}
{%- endif -%}

{%- comment -%} Get collection {%- endcomment -%}
{%- assign collection = nil -%}
{%- if collection_handle != blank -%}
  {%- assign collection = collections[collection_handle] -%}
{%- elsif section.settings.collection -%}
  {%- assign collection = section.settings.collection -%}
{%- endif -%}

{%- comment -%} Extract unique product categories from collection {%- endcomment -%}
{%- assign categories_array = collection.all_types -%}

{%- comment -%} ========================================
  FONT LOADING
======================================== {%- endcomment -%}

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@400;500;600&display=swap" rel="stylesheet">

{%- comment -%} ========================================
  MAIN PAGE CONTAINER
======================================== {%- endcomment -%}

<section
  class="cb-commerce-page"
  data-view="browse"
  data-creator="{{ username }}"
  data-user-id="{{ user_id }}"
  data-collection="{{ collection_handle }}"
  data-alignment="{{ text_alignment }}"
  data-nav-style="{{ navigation_style }}"
  style="
    --cb-bg-primary: {{ bg_primary }};
    --cb-bg-secondary: {{ bg_secondary }};
    --cb-text-dark: {{ text_dark }};
    --cb-text-medium: {{ text_dark | color_modify: 'alpha', 0.7 }};
    --cb-text-light: {{ text_dark | color_modify: 'alpha', 0.5 }};
    --cb-text-muted: {{ text_dark | color_modify: 'alpha', 0.4 }};
    --cb-text-primary: {{ text_dark }};
    --cb-text-secondary: {{ text_dark | color_modify: 'alpha', 0.85 }};
    --cb-text-tertiary: {{ text_dark | color_modify: 'alpha', 0.6 }};
    --cb-card-bg: rgba(255,255,255,0.7);
    --cb-border: {{ text_dark | color_modify: 'alpha', 0.15 }};
    --cb-accent: {{ accent_color }};
  "
>

  {%- comment -%} ========== HERO BANNER ========== {%- endcomment -%}
  {%- render 'cb-v2-hero',
    banner_image_url: banner_image_url,
    creator_name: creator_name,
    creator_tags: creator_tags,
    bio: bio,
    avatar_url: avatar_url,
    b_score: b_score,
    b_score_reviews: b_score_reviews,
    enable_email_signup: enable_email_signup,
    text_alignment: text_alignment,
    name_single_line: name_single_line
  -%}

  {%- comment -%} ========== CONTENT AREA ========== {%- endcomment -%}
  <div class="cb-content-area">
    {%- render 'cb-v2-browse-view',
      creator_name: creator_name,
      username: username,
      collection: collection,
      categories_array: categories_array,
      links_json: links_json,
      videos_json: videos_json,
      social_stats: social_stats,
      social_proof_cards: social_proof_cards,
      instagram_url: instagram_url,
      tiktok_url: tiktok_url,
      youtube_url: youtube_url,
      twitter_url: twitter_url,
      enable_music_player: enable_music_player,
      music_player_title: music_player_title,
      music_player_theme: music_player_theme,
      music_items: music_items,
      navigation_style: navigation_style,
      text_alignment: text_alignment
    -%}
  </div>

  {%- comment -%} ========== EMAIL SIGNUP MODAL ========== {%- endcomment -%}
  {%- if enable_email_signup -%}
    <div class="cb-modal" id="emailModal" style="display: none;">
      <div class="cb-modal__backdrop" data-action="close-modal"></div>
      <div class="cb-modal__content">
        <button class="cb-modal__close" data-action="close-modal" aria-label="Close">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
        <h3 class="cb-modal__title">{{ email_signup_title | default: 'Stay Updated' }}</h3>
        <p class="cb-modal__desc">{{ email_signup_description | default: 'Get updates on new products and exclusive offers.' }}</p>
        <form class="cb-email-form" id="emailSignupForm">
          <input
            type="email"
            id="emailInput"
            name="email"
            class="cb-email-input"
            placeholder="your@email.com"
            required
            aria-label="Email address"
          >
          <button type="submit" class="cb-email-btn" id="emailSubmitBtn">
            Subscribe
          </button>
        </form>
        <div class="cb-email-message" id="emailMessage"></div>
      </div>
    </div>
  {%- endif -%}

  {%- comment -%} ========== POWERED BY FOOTER ========== {%- endcomment -%}
  <div class="cb-footer">
    <a href="https://creatorb.io" target="_blank" rel="noopener" class="cb-footer__link">
      Powered by <strong>CreatorB</strong>
    </a>
  </div>

</section>

{%- comment -%} ========================================
  INLINE STYLES (can be moved to external CSS)
======================================== {%- endcomment -%}

{{ 'cb-commerce-v2.css' | asset_url | stylesheet_tag }}

{%- comment -%} ========================================
  JAVASCRIPT CONTROLLER
======================================== {%- endcomment -%}

<script src="{{ 'cb-commerce-v2.js' | asset_url }}" defer></script>

<script>
  // Initialize with server-side data
  window.CB_CONFIG = {
    creator: {{ username | json }},
    userId: {{ user_id | json }},
    collectionHandle: {{ collection_handle | json }},
    workerUrl: 'https://creatorbio-pricing.shopamorayou.workers.dev',
    analyticsUrl: 'https://creatorb.io/api'
  };
</script>

{%- comment -%} ========================================
  SCHEMA
======================================== {%- endcomment -%}

{% schema %}
{
  "name": "Creator Bio Commerce V2",
  "tag": "section",
  "class": "cb-commerce-section",
  "settings": [
    {
      "type": "text",
      "id": "creator_name",
      "label": "Creator Name (fallback)",
      "default": "Creator"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Product Collection (fallback)"
    },
    {
      "type": "select",
      "id": "text_alignment",
      "label": "Hero Text Alignment",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" }
      ],
      "default": "left"
    },
    {
      "type": "checkbox",
      "id": "name_single_line",
      "label": "Display name on single line",
      "default": false
    },
    {
      "type": "select",
      "id": "navigation_style",
      "label": "Bottom Navigation Style",
      "options": [
        { "value": "tabs", "label": "Tabs" },
        { "value": "onepage", "label": "One Page Scroll" }
      ],
      "default": "tabs"
    },
    {
      "type": "color",
      "id": "bg_primary",
      "label": "Background Primary",
      "default": "#D4C4A8"
    },
    {
      "type": "color",
      "id": "bg_secondary",
      "label": "Background Secondary",
      "default": "#C9B896"
    },
    {
      "type": "color",
      "id": "text_dark",
      "label": "Text Color",
      "default": "#3C3226"
    },
    {
      "type": "color",
      "id": "accent_color",
      "label": "Accent Color",
      "default": "#1A1A1A"
    }
  ],
  "presets": [
    {
      "name": "Creator Bio Commerce V2"
    }
  ]
}
{% endschema %}
